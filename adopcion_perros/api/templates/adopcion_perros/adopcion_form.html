{% extends 'adopcion_perros/base.html' %}
{% load static %}

{% block title %}Formulario de Adopci√≥n - Huellitas{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'adopcion_perros/css/estilos_formularios_adopcion2.css' %}">
{% endblock %}

{% block content %}
<div class="form-container">
  <div class="form-box">
    <div class="form-header">
      <h2>üê∂ Solicitud de Adopci√≥n</h2>
      <p>Completa el formulario para darle un hogar a una mascota</p>
    </div>

    {% if user.is_authenticated %}
      <form id="adopcionForm">
        {% csrf_token %}
        <!-- Nombre y correo de usuario, solo lectura -->
        <input type="text" name="nombre_completo" value="{{ request.user.username }}" readonly style="background:#f0f0f0; color:#333;">
        <input type="email" name="email" value="{{ request.user.email }}" readonly style="background:#f0f0f0; color:#333;">
        <!-- Tel√©fono editable -->
        <input type="tel" name="telefono" placeholder="Tel√©fono (10 d√≠gitos)" required pattern="[0-9]{10}" title="Debe tener 10 d√≠gitos num√©ricos">
        <!-- Mascota disponible -->
        <select name="mascota" required>
          <option value="">Selecciona una mascota</option>
          {% for mascota in mascotas %}
            <option value="{{ mascota.id }}">{{ mascota.nombre }} ({{ mascota.tipo }})</option>
          {% endfor %}
        </select>
        <!-- Mensaje -->
        <textarea name="mensaje" placeholder="Cu√©ntanos por qu√© deseas adoptar" required minlength="10" maxlength="500"></textarea>
        <button type="submit">Enviar solicitud</button>
      </form>

      <div id="mensajeExito" class="success-message" style="display:none; margin-top:16px;">
        ¬°Solicitud enviada correctamente! ‚ù§Ô∏è
      </div>

      <script>
      document.getElementById("adopcionForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        const form = this;
        const telefono = form.telefono.value.trim();
        const mensaje = form.mensaje.value.trim();
        const mascota = form.mascota.value;

        if (!/^\d{10}$/.test(telefono)) return alert("El tel√©fono debe tener 10 d√≠gitos num√©ricos.");
        if (!mascota) return alert("Debes seleccionar una mascota.");
        if (mensaje.length < 10) return alert("El mensaje debe tener al menos 10 caracteres.");

        const datos = {
          nombre_completo: form.nombre_completo.value,
          email: form.email.value,
          telefono: telefono,
          mascota: mascota,
          mensaje: mensaje
        };
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const response = await fetch("{% url 'api_adopciones' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify(datos)
        });

        if (response.ok) {
          document.getElementById("mensajeExito").style.display = "block";
          form.reset();
        } else {
          const error = await response.json();
          alert("Error al enviar la solicitud: " + JSON.stringify(error));
        }
      });
      </script>
    {% else %}
      <p style="text-align:center; margin-top:20px;">
        Debes <a href="{% url 'login' %}">iniciar sesi√≥n</a> o <a href="{% url 'registro' %}">registrarte</a> para solicitar una adopci√≥n.
      </p>
    {% endif %}
  </div>
</div>
{% endblock %}
